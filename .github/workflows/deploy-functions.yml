name: Deploy Cloud Functions

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main]
  push:
    branches: [main]
    paths:
      - "firestore.rules"
      - "firestore.indexes.json"
      - ".github/workflows/deploy-functions.yml"
  pull_request:
    branches: [main]
    paths:
      - "apps/functions/**"
      - "firestore.rules"
      - "firestore.indexes.json"

permissions:
  contents: read
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ vars.TURBO_TEAM }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        env:
          HUSKY: 0
        run: npm ci

      - name: Build and test functions
        run: |
          npm run functions:build
          npm run functions:test
          npm run functions:lint

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.ref == 'refs/heads/main' && github.event_name == 'push')
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ vars.TURBO_TEAM }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Install dependencies
        env:
          HUSKY: 0
        run: npm ci

      - name: Build functions
        run: npm run functions:build

      - name: Authenticate to Firebase
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          if [ -z "$FIREBASE_SERVICE_ACCOUNT" ]; then
            echo "❌ FIREBASE_SERVICE_ACCOUNT secret is empty or not set"
            exit 1
          fi

          echo "🔐 Using service account key for authentication"
          echo "$FIREBASE_SERVICE_ACCOUNT" > "$HOME/gcloud-service-key.json"
          export GOOGLE_APPLICATION_CREDENTIALS="$HOME/gcloud-service-key.json"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud-service-key.json" >> $GITHUB_ENV

          if jq . "$HOME/gcloud-service-key.json" > /dev/null 2>&1; then
            echo "✅ Service account key is valid JSON"
          else
            echo "❌ Service account key is not valid JSON"
            exit 1
          fi

      - name: Deploy to Firebase
        run: |
          echo "🚀 Deploying Cloud Functions..."
          firebase projects:list --project ichizen-daily-good-deeds
          FIREBASE_DEPLOY_AGENT=github-actions firebase deploy --only functions --project ichizen-daily-good-deeds --debug

      - name: Deployment notification
        if: success()
        run: |
          echo "🚀 Cloud Functions deployed successfully!"
          echo "📊 Functions URL: https://asia-northeast1-ichizen-daily-good-deeds.cloudfunctions.net"

      - name: Deployment failure notification
        if: failure()
        run: |
          echo "❌ Cloud Functions deployment failed!"
          exit 1
